<!DOCTYPE html>
<html>
<head>
    <title>Locate My Buddies</title>
    <style>
        /* Set the size of the map div */
        #map {
            height: 600px;
            width: 100%;
        }
        .map-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;  /* Adjust the height as needed */
        }
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px; /* Add space between elements */
            margin-bottom: 20px; /* Add space below the controls */
        }
        #user-form {
            display: flex;
            align-items: center;
            gap: 10px; /* Add space between form elements */
        }
    </style>
</head>
<body>
    
    <h2 align="center"> Locate your badminton buddies and courts </h2>
    
    <div class="controls-container">
        
        <!-- Form to capture user's name -->
        <form id="user-form">
            <label for="name">Your Name:</label>
            <input type="text" id="name" name="name" required>
            <button type="button" onclick="generateRandomName()">Assign Random Name</button>
            <button type="submit">Submit</button>
        </form>
        
        <label for="radius">Enter radius (km):</label>
        <input type="number" id="radius" name="radius" min="1" value="2">
        <button onclick="updateMap()">Update Map</button>
    
    </div>

    <!-- The div element where the map will be displayed -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- Include the Google Maps JavaScript API with your API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=<API_KEY>&callback=initMap" async defer></script>

    <!-- Initialize and add the map -->
    <script>

        let map; // Declare map variable outside initMap
        let centerLat;
        let centerLong;
        let mapMarkers = [];
        
        // Function to initialize the map
        function initMap() {
            console.log('initMap called'); // Debug log

            // Check if the browser supports geolocation
            if (navigator.geolocation) {
                // Get the user's current position
                navigator.geolocation.getCurrentPosition(position => {
                    const initialLat = position.coords.latitude;
                    const initialLng = position.coords.longitude;
                    const initialRadius = parseFloat(document.getElementById('radius').value); // Get radius from input

                    centerLat = initialLat;
                    centerLong = initialLng;
                    // Fetch coordinates from the server
                    fetch(`/api/coordinates?latitude=${initialLat}&longitude=${initialLng}&radius=${initialRadius}`)
                        .then(response => response.json())
                        .then(coordinates => {
                            console.log('Coordinates fetched:', coordinates); // Debug log

                            // The map, centered at the user's location
                                map = new google.maps.Map(document.getElementById('map'), {
                                zoom: 14,
                                center: { lat: initialLat, lng: initialLng },
                                disableDefaultUI: true,
                                styles: [
                                    {
                                        featureType: "poi",
                                        stylers: [{ visibility: "off" }]
                                    },
                                    {
                                        featureType: "administrative.locality",
                                        stylers: [{ visibility: "off" }]
                                    }
                                ]
                            });

                            // Add markers to the map
                            coordinates.forEach(coord => {
                                console.log('Adding marker:', coord); // Debug log
                                const marker = new google.maps.Marker({
                                    position: { lat: coord.latitude, lng: coord.longitude },
                                    map: map,
                                    title: `Latitude: ${coord.latitude}, Longitude: ${coord.longitude}`,
                                    label: {
                                        text: coord.name,
                                        fontSize: '10px', // Set the font size here
                                        fontWeight: 'bold'
                                    },                              
                                    icon: coord.locationType === 'person' ? { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' } : undefined
                                });
                                mapMarkers.push(marker);
                            });

                            // Add a marker for the user's location
                            const userMarker = new google.maps.Marker({
                                position: { lat: initialLat, lng: initialLng },
                                map: map,
                                title: 'Your Location',
                                label: {
                                    text: 'You',
                                    fontSize: '10px', // Set the font size here
                                    fontWeight: 'bold'
                                },
                                icon: {
                                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                                }
                            });
                            mapMarkers.push(userMarker);
                            
                            // Center the map on the user's location
                            map.setCenter({ lat: initialLat, lng: initialLng });
                            console.log("Center is :" + map.getCenter());
                        })
                        .catch(error => console.error('Error fetching coordinates:', error));
                }, () => {
                    alert('Error while getting your location. Please turn on the location sharing');
                    handleLocationError(true);
                });
            } else {
                // Browser doesn't support geolocation
                handleLocationError(false);
            }
        }

        // Function to update the map with the new radius
        function updateMap() {
            const radius = parseFloat(document.getElementById('radius').value);
            const center = map.getCenter(); // Get the current center of the map

            // Fetch coordinates from the server with the new radius
            fetch(`/api/coordinates?latitude=${center.lat()}&longitude=${center.lng()}&radius=${radius}`)
                .then(response => response.json())
                .then(coordinates => {
                    console.log('Coordinates fetched:', coordinates); // Debug log

                    // Remove existing markers
                    mapMarkers.forEach(marker => {
                        marker.setMap(null);
                    });
                    mapMarkers = []; // Clear the markers array
                   

                    // Add markers for the new coordinates
                    coordinates.forEach(coord => {
                        console.log('Adding marker:', coord); // Debug log
                        const marker = new google.maps.Marker({
                            position: { lat: coord.latitude, lng: coord.longitude },
                            map: map,
                            title: `Latitude: ${coord.latitude}, Longitude: ${coord.longitude}`,
                            label: {
                                text: coord.name,
                                fontSize: '10px', // Set the font size here
                                fontWeight: 'bold'
                            },
                            icon: coord.locationType === 'person' ? { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' } : undefined
                        });
                        mapMarkers.push(marker);
                    });

                    // Add a marker for the user's location again
                    const userMarker = new google.maps.Marker({
                        position: { lat: centerLat, lng: centerLong },
                        map: map,
                        title: 'Your Location',
                        label: {
                            text: 'You',
                            fontSize: '10px', // Set the font size here
                            fontWeight: 'bold'
                        },
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                        }
                    });
                    mapMarkers.push(userMarker);

                    // Update the map center
                    map.setCenter(center);
                })
                .catch(error => console.error('Error fetching coordinates:', error));
        }

        // Handle Geolocation errors
        function handleLocationError(browserHasGeolocation, pos) {
            console.error(browserHasGeolocation
                ? 'Error: The Geolocation service failed.'
                : 'Error: Your browser doesn\'t support geolocation.');
        }

        // Ensure initMap is called after the API script is loaded
        window.initMap = initMap;

        // Add event listener for form submission
        document.getElementById('user-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const userConsent = confirm("Please select OK if you would like to share your location. By selecting cancel you can still see badminton courts.");
            if (userConsent) {
                //alert("Form submitted successfully!");
                //this.submit(); // Proceed with form submission

                const name = document.getElementById('name').value;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const locationType = "person";

                    // Send the user's name and location to the server
                    fetch('/api/store-location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, latitude, longitude, locationType })
                    })
                    .then(response => response.text())
                    .then(message => {
                        console.log(message); // Log the server's response
                        alert('Thank you! Your Location is stored successfully. Your buddies can now locate you');
                    })
                    .catch(error => console.error('Error storing location:', error));
                });
            } else {
                alert('Geolocation is not supported by your browser.');
            }
            } else {
                alert("Form submission canceled.");
            }


            
        });

        function generateRandomName() {
            fetch('/random-name')
            .then(response => response.json())
            .then(data => {
                document.getElementById('name').value = data.name;
            });
        }
    </script>

</body>
</html>
